
from Scanners import Scanners
import requests                 #requests to the site
from pprint import pprint
from bs4 import BeautifulSoup as bs    #for pulling data from HTML
from urllib.parse import urljoin        #for combining URLs

class XssScanner(Scanners):

    #def __init__(self):
     #   pass

    def __del__(self):
        print("[*] Completed!")

    @staticmethod
    def get_script():
        script = input('Provide your script: ')
        return script

    #getting list of forms from html as soup objects
    @staticmethod
    def get_forms_html(url):
        request = requests.get(url).content   # perform request to the site
        usesoup = bs(request, 'html.parser')  # parsing to html data structure
        print('[*] Succesfully generated html forms')
        return usesoup.find_all('form')       # return forms from html site's structure

    #getting form's attributes: action, methods, inputs
    @staticmethod
    def get_form_details(form):
        formdetails = {}                      # dictionary for action, method and input
        action = form.attrs.get('action').lower()   #get action and method form
        method = form.attrs.get('method', 'get').lower()

        form_inputs = []
        # get type, text and name of input
        for input_tag in form.find_all("input"):
            input_type = input_tag.attrs.get("type", "text")
            input_name = input_tag.attrs.get("name")
            form_inputs.append({"type": input_type, "name": input_name})
        # put everything to the resulting dictionary
        formdetails["action"] = action
        formdetails["method"] = method
        formdetails["inputs"] = form_inputs
        return formdetails

    # submiting form with script to test vulnerability
    @staticmethod
    def send_form(form_details, url, given_script):
        # create URL with proper action
        target_url = urljoin(url, form_details["action"])
        # get the inputs
        inputs = form_details["inputs"]
        data = {}
        for input in inputs:
            # replace all text and search values with user's script
            if input["type"] == "text" or input["type"] == "search" or input["type"] == "hidden":
                input["value"] = r"""{}""".format(given_script)         # formating to raw with quotes option
            input_name = input.get("name")
            input_value = input.get("value")
            if input_name and input_value:
                # add input name and value to data
                data[input_name] = input_value

        # return HTTP response to submited form, POST and GET
        if form_details["method"] == "post":
            return requests.post(target_url, data=data)
        else:
            # GET request
            return requests.get(target_url, params=data)