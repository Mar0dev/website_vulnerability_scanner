from Scanners import Scanners
from selenium import webdriver # Importing selenium's webdriver
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as ec  # Import libraries
from selenium.common.exceptions import TimeoutException
import warnings
import sys
import platform
# Ignoring warnings
warnings.filterwarnings('ignore')
# Setting options for chrome webdriver
options = webdriver.ChromeOptions()
options.add_argument('--headless')
options.add_argument('--disable-xss-auditor')
options.add_argument('--disable-web-security')
options.add_argument('--ignore-certificate-errors')
options.add_argument('--no-sandbox')
options.add_argument('--log-level=3')
options.add_argument('--disable-notifications')
driver = webdriver.Chrome


class XssAttack(Scanners):

    def __del__(self):
        print("[*] Completed!")

    #method for initializing chrome webdriver
    @staticmethod
    def create_driver_chrome():
        print('If you dont have chromedriver installed please download it from the Internet')
        print('for linux default path is: /usr/bin/chromedriver')
        print('Windows example: C:\Windows\chromedriver.exe')
        chromepath = input('[*] Provide chromedriver path: ')
        globals().update(driver = webdriver.Chrome(executable_path=chromepath, chrome_options=options))

    #get path to payloads
    @staticmethod
    def get_payloads_path():
        payloads_path = input('[*] Provide path to payloads: ')
        payloads_path_raw = r'{}'.format(payloads_path)         #formating string to raw string to prevent path issues
        try:                                                    #trying to open file
            f = open(payloads_path_raw, "r")
            print('[*] File found')
            f.close()
        except OSError:
           sys.exit("[*] File can't be opened")
        return payloads_path_raw

    #Searching for successful attacks
    @staticmethod
    def find_xss_attack(url, payloads_path):
        system = platform.system().lower()                      #checking system to choose proper payloads encoding
        if system == 'windows' or 'darwin':
            encoded_file = open(payloads_path, "r", encoding='UTF-8')
        else:
            encoded_file = open(payloads_path, "r")

        target_website = url
        for payload in encoded_file.readlines():
            url_try = target_website + payload
            driver.get(url_try)                                 #connecting to URL
            try:
                WebDriverWait(driver, 2).until(ec.alert_is_present())       #waiting for alert
                alert = driver.switch_to_alert()
                alert.accept()
                print("[*] XSS alert succeed with: ", payload)
            except TimeoutException:
                pass